# Blnk v0.11.0 Migration Guide

## Overview

This migration guide covers the breaking changes introduced in Blnk v0.11.0, specifically related to Typesense/Search functionality. The main changes involve upgrading from Typesense 0.23.x to 0.24.x and updating the corresponding Go client library.

## Breaking Changes Summary

### 1. Typesense Server Upgrade
- **From:** Typesense 0.23.x
- **To:** Typesense 0.24.x
- **Impact:** Breaking changes in API compatibility and schema handling

### 2. Typesense Go Client
- **Current Version:** `github.com/typesense/typesense-go v1.1.0`
- **Impact:** Updated client library with improved API compatibility for Typesense 0.24.x

## Migration Steps

### Step 1: Update Docker Configuration

#### For Production (`docker-compose.yaml`)
```yaml
# Before (v0.10.x and lower)
typesense:
  image: typesense/typesense:0.23.1

# After (v0.11.0)
typesense:
  image: typesense/typesense:0.24.0
```

#### For Development (`docker-compose.dev.yaml`)
```yaml
# Before (v0.10.x and lower)
typesense:
  image: typesense/typesense:0.23.1

# After (v0.11.0)
typesense:
  image: typesense/typesense:0.24.0
```

#### For Kubernetes (`infrastructure/k8s-manifests/typesense-deployment.yaml`)
```yaml
# Before (v0.10.x and lower)
containers:
  - image: typesense/typesense:0.23.1

# After (v0.11.0)
containers:
  - image: typesense/typesense:0.24.0
```

### Step 2: Schema Migration

The new version includes automatic schema migration capabilities. When you start Blnk v0.11.0, it will automatically:

1. **Detect existing collections** in your Typesense instance
2. **Compare schemas** between your current collections and the latest schema definitions
3. **Add new fields** to existing collections without data loss
4. **Create missing collections** with the latest schema

#### Collections Affected
- `ledgers`
- `balances` 
- `transactions`
- `reconciliations`
- `identities`

#### Schema Changes
The following schema improvements have been made:

**Ledgers Collection:**
- Enhanced metadata handling with object type support
- Improved nested field support

**Balances Collection:**
- All balance fields now use `string` type for precise decimal handling
- Enhanced metadata object support
- Improved nested field capabilities

**Transactions Collection:**
- `precise_amount` field uses `string` type for exact decimal precision
- Enhanced metadata object support
- Improved nested field capabilities

**Reconciliations Collection:**
- No breaking changes to existing fields
- Enhanced performance optimizations

**Identities Collection:**
- Enhanced metadata object support
- Improved nested field capabilities

### Step 3: Data Migration

#### Automatic Data Processing
Blnk v0.11.0 includes automatic data processing for:

1. **Large Number Conversion:** Automatically converts `big.Int` values to strings for Typesense compatibility
2. **Metadata Normalization:** Handles metadata field normalization for object schemas
3. **Time Field Normalization:** Ensures consistent timestamp formatting

#### Manual Data Verification (Recommended)
After migration, verify your data integrity:

```bash
# Check collection health
curl -H "X-TYPESENSE-API-KEY: blnk-api-key" \
  "http://localhost:8108/collections/balances/documents/search?q=*"

# Verify schema updates
curl -H "X-TYPESENSE-API-KEY: blnk-api-key" \
  "http://localhost:8108/collections/balances"
```

### Step 4: Configuration Updates

#### Environment Variables
No changes to environment variables are required. The following configuration remains the same:

```bash
BLNK_TYPESENSE_DNS=http://localhost:8108
BLNK_TYPESENSE_KEY=blnk-api-key
```

#### Configuration File (`blnk.json`)
No changes to the configuration file structure are required.

### Step 5: API Compatibility

#### Search API
The search API endpoints remain unchanged:

```bash
# Single collection search
POST /search/{collection}

# Multi-search
POST /multi-search
```

#### Response Format
Search response formats remain compatible with previous versions.

## Rollback Plan

If you need to rollback to a previous version:

### 1. Downgrade Typesense Server
```yaml
# In docker-compose.yaml
typesense:
  image: typesense/typesense:0.23.1
```

### 2. Restore Data Backup
If you have a data backup from before the migration:
```bash
# Stop Typesense
docker-compose down

# Restore data volume
docker volume rm blnk_typesense_data
# Restore your backup to the typesense_data volume

# Restart services
docker-compose up -d
```

### 3. Downgrade Blnk
```bash
git checkout v0.10.x  # or your previous version
docker-compose down
docker-compose up -d
```

## Testing Checklist

After migration, verify the following:

- [ ] Typesense server starts successfully
- [ ] All collections are accessible
- [ ] Search functionality works correctly
- [ ] Data integrity is maintained
- [ ] API endpoints respond correctly
- [ ] No errors in application logs

## Troubleshooting

### Common Issues

#### 1. Collection Schema Errors
**Error:** `Collection schema mismatch`
**Solution:** The automatic schema migration should handle this. If issues persist, delete and recreate the collection:

```bash
# Delete collection (WARNING: This will delete all data)
curl -X DELETE -H "X-TYPESENSE-API-KEY: blnk-api-key" \
  "http://localhost:8108/collections/{collection_name}"

# Restart Blnk to recreate with new schema
docker-compose restart blnk
```

#### 2. Search Performance Issues
**Issue:** Slower search performance after migration
**Solution:** Reindex your data:

```bash
# Trigger reindexing by restarting Blnk
docker-compose restart blnk
```

#### 3. Metadata Field Errors
**Error:** `Invalid metadata field format`
**Solution:** The new version automatically handles metadata normalization. If issues persist, check your data format.

### Getting Help

If you encounter issues during migration:

1. Check the [GitHub Issues](https://github.com/blnkfinance/blnk/issues/190)
2. Join our [Discord Community](https://discord.gg/7WNv94zPpx)
3. Review the [Documentation](https://docs.blnkfinance.com)

## Performance Improvements

Blnk v0.11.0 includes several performance improvements:

1. **Enhanced Search Performance:** Optimized query execution
2. **Improved Memory Usage:** Better resource management
3. **Faster Schema Updates:** Streamlined collection management
4. **Better Error Handling:** More robust error recovery

## Security Updates

- Updated Typesense client library with security patches
- Enhanced API key validation
- Improved connection security

## Next Steps

After successful migration:

1. Monitor system performance for 24-48 hours
2. Update your monitoring dashboards if needed
3. Consider enabling additional observability features
4. Review and update your backup procedures

---

**Note:** This migration guide covers the breaking changes in Blnk v0.11.0. For additional features and improvements, refer to the [release notes](https://github.com/blnkfinance/blnk/releases/tag/v0.11.0).

**Support:** For migration assistance, please reach out through our [Discord community](https://discord.gg/7WNv94zPpx) or [GitHub issues](https://github.com/blnkfinance/blnk/issues).